name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üöÄ Deploy to Production Server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 30m
          script_stop: false
          debug: true
          script: |
            set -x
            echo "=== Iniciando deployment ==="
            cd ~/ruteo || { echo "Error: No se pudo acceder a ~/ruteo"; exit 1; }
            echo "=== Directorio actual: $(pwd) ==="
            
            echo "=== Git pull ==="
            git pull origin main || { echo "Error en git pull"; exit 1; }
            
            echo "=== Docker compose down ==="
            docker compose down || { echo "Error en compose down"; exit 1; }
            
            echo "=== Docker compose build (sin cache) ==="
            docker compose build --no-cache || { echo "Error en compose build"; exit 1; }
            
            echo "=== Docker compose up -d ==="
            docker compose up -d || { echo "Error en compose up"; exit 1; }
            
            echo "=== Esperando 15 segundos ==="
            sleep 15
            
            echo "=== Verificando contenedores ==="
            docker ps
            
            echo "=== Limpiando im√°genes viejas ==="
            docker image prune -f || echo "No hay im√°genes para limpiar"
            
            echo "‚úÖ Deployment completed successfully"

      - name: ‚è≥ Wait for service to be ready
        run: sleep 20
        
      - name: üè• Health Check
        run: |
          echo "Checking service health at http://${{ secrets.SSH_HOST }}:8080/health"
          curl -v -f http://${{ secrets.SSH_HOST }}:8080/health 2>&1 || echo "‚ö†Ô∏è Health check failed but deployment may have completed"

      - name: ‚úÖ Deployment Status
        if: success()
        run: echo "Deployment completed successfully!"
        
      - name: ‚ùå Deployment Failed
        if: failure()
        run: echo "Deployment failed! Check logs above."
